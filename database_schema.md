# LPG Inventory Management System - Database Schema

## Overview
This document defines the PostgreSQL database schema for the LPG Inventory Management System. The schema is designed with data integrity, security, and performance in mind, implementing proper normalization and constraints.

## Core Tables

### 1. profiles
Stores user profile information linked to Supabase Auth users.

```sql
CREATE TABLE profiles (
  id UUID REFERENCES auth.users ON DELETE CASCADE NOT NULL PRIMARY KEY,
  updated_at TIMESTAMP WITH TIME ZONE,
  full_name TEXT,
  avatar_url TEXT,
  website TEXT,
  role TEXT CHECK (role IN ('admin', 'warehouse', 'delivery')) DEFAULT 'delivery'
);

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
```

### 2. customers
Information about business and residential customers.

```sql
CREATE TABLE customers (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  name TEXT NOT NULL,
  address TEXT,
  contact_person TEXT,
  phone TEXT,
  email TEXT,
  is_business BOOLEAN DEFAULT FALSE
);

ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
```

### 3. cylinder_types
Different types of LPG cylinders (size, weight, etc.).

```sql
CREATE TABLE cylinder_types (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  name TEXT NOT NULL UNIQUE,
  weight DECIMAL(5,2),
  capacity DECIMAL(5,2) -- in liters
);

ALTER TABLE cylinder_types ENABLE ROW LEVEL SECURITY;
```

### 4. cylinders
Individual LPG cylinders with their status and location.

```sql
CREATE TYPE cylinder_status AS ENUM (
  'registered',
  'in_stock',
  'dispatched',
  'delivered',
  'returned',
  'damaged',
  'retired'
);

CREATE TABLE cylinders (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  serial_number TEXT NOT NULL UNIQUE,
  cylinder_type_id BIGINT REFERENCES cylinder_types(id) NOT NULL,
  status cylinder_status DEFAULT 'registered',
  current_customer_id BIGINT REFERENCES customers(id),
  notes TEXT
);

ALTER TABLE cylinders ENABLE ROW LEVEL SECURITY;
```

### 5. transactions
Immutable log of all cylinder status changes.

```sql
CREATE TABLE transactions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  cylinder_id BIGINT REFERENCES cylinders(id) NOT NULL,
  from_status cylinder_status,
  to_status cylinder_status NOT NULL,
  performed_by UUID REFERENCES profiles(id) NOT NULL,
  notes TEXT
);

ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
```

### 6. dispatch_orders
Tracks delivery orders for cylinders to customers.

```sql
CREATE TABLE dispatch_orders (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  dispatched_at TIMESTAMP WITH TIME ZONE,
  delivered_at TIMESTAMP WITH TIME ZONE,
  returned_at TIMESTAMP WITH TIME ZONE,
  delivery_person_id UUID REFERENCES profiles(id),
  customer_id BIGINT REFERENCES customers(id) NOT NULL,
  status TEXT CHECK (status IN ('pending', 'dispatched', 'delivered', 'returned', 'cancelled')) DEFAULT 'pending'
);

ALTER TABLE dispatch_orders ENABLE ROW LEVEL SECURITY;
```

### 7. dispatch_order_items
Link table between dispatch orders and cylinders.

```sql
CREATE TABLE dispatch_order_items (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  dispatch_order_id BIGINT REFERENCES dispatch_orders(id) ON DELETE CASCADE NOT NULL,
  cylinder_id BIGINT REFERENCES cylinders(id) NOT NULL,
  UNIQUE(dispatch_order_id, cylinder_id)
);

ALTER TABLE dispatch_order_items ENABLE ROW LEVEL SECURITY;
```

## Relationships Summary
- Each `cylinder` has one `cylinder_type`
- Each `cylinder` can be assigned to one `customer` (when not in stock)
- Each `transaction` records a status change for one `cylinder`
- Each `dispatch_order` is associated with one `customer` and one `delivery_person`
- Each `dispatch_order` can contain multiple `cylinders` through `dispatch_order_items`

## Constraints and Indexes

### Unique Constraints
- `cylinders.serial_number` is UNIQUE
- `cylinder_types.name` is UNIQUE
- `dispatch_order_items(dispatch_order_id, cylinder_id)` is UNIQUE

### Indexes
```sql
-- For faster lookups by status
CREATE INDEX idx_cylinders_status ON cylinders(status);

-- For faster lookups by serial number
CREATE INDEX idx_cylinders_serial ON cylinders(serial_number);

-- For faster lookups by customer
CREATE INDEX idx_cylinders_customer ON cylinders(current_customer_id);

-- For faster lookups by cylinder in transactions
CREATE INDEX idx_transactions_cylinder ON transactions(cylinder_id);

-- For faster lookups by dispatch order in items
CREATE INDEX idx_dispatch_order_items_order ON dispatch_order_items(dispatch_order_id);

-- For faster lookups by cylinder in dispatch order items
CREATE INDEX idx_dispatch_order_items_cylinder ON dispatch_order_items(cylinder_id);
```

## RLS Policies (to be implemented)

### profiles
- Users can view and update their own profile
- Admins can view and update all profiles

### customers
- All authenticated users can view customers
- Warehouse and admin roles can create/update customers

### cylinder_types
- All authenticated users can view
- Admin role can create/update

### cylinders
- All authenticated users can view in_stock cylinders
- Warehouse and admin can view all cylinders
- Delivery can view cylinders assigned to their active dispatch orders

### transactions
- All authenticated users can view transactions for cylinders they can see
- Insertions are handled by backend triggers

### dispatch_orders
- Users can view their own dispatch orders
- Delivery can view orders assigned to them
- Warehouse and admin can view all orders

### dispatch_order_items
- Access controlled through dispatch_orders